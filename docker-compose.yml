version: '3.8'

# Production configuration
# Start with: docker compose up -d

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: service_manager_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: fdh_service_manager
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - service_manager_network

  # MSSQL Database
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: service_manager_mssql
    user: "0:0"
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "YourStrong!Passw0rd" # TODO: override via env var in real use
      MSSQL_PID: "Developer"
    ports:
      - "1433:1433"
    volumes:
      - ./mssql_data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U SA -P $SA_PASSWORD -Q 'SELECT 1' -No -C || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - service_manager_network

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: service_manager_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    volumes:
      - ./minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - service_manager_network

  # MailHog - Email Testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: service_manager_mailhog
    ports:
      - "1025:1025"  # SMTP
      - "8025:8025"  # Web UI
    restart: unless-stopped
    networks:
      - service_manager_network
    logging:
      driver: "none"  # Disable logs to reduce noise

  # Redis for PubSub & Caching
  redis:
    image: redis:7-alpine
    container_name: service_manager_redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_dev_password}
    ports:
      - "6379:6379"
    volumes:
      - ./redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - service_manager_network

  # Next.js Admin Panel (production build)
  adminpanel:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: service_manager_adminpanel
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
      - ./backups:/app/backups
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - service_manager_network
    environment:
      NODE_ENV: development
      DATABASE_URL: "postgresql://postgres:postgres@db:5432/service_manager"
      JWT_SECRET: "${JWT_SECRET:-change-this-to-a-secure-random-string-in-production}"
      JWT_EXPIRES_IN: "${JWT_EXPIRES_IN:-24h}"
      BACKUP_DIR: "/app/backups"
      MINIO_ENDPOINT: "minio"
      MINIO_PORT: "9000"
      MINIO_USE_SSL: "false"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY:-minioadmin}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY:-minioadmin}"
      MINIO_BUCKET_NAME: "${MINIO_BUCKET_NAME:-backups}"
      SMTP_HOST: "mailhog"
      SMTP_PORT: "1025"
      SMTP_USER: ""
      SMTP_PASSWORD: ""
      SMTP_FROM: "noreply@servicemanager.local"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD:-redis_dev_password}"
      # T24 Configuration
      T24_BASE_URL: "${T24_BASE_URL:-https://fdh-esb.ngrok.dev}"
      T24_USERNAME: "${T24_USERNAME:-admin}"
      T24_PASSWORD: "${T24_PASSWORD:-admin}"
      # Background services
      BALANCE_SYNC_INTERVAL: "${BALANCE_SYNC_INTERVAL:-300000}"
      ACCOUNT_DISCOVERY_INTERVAL: "${ACCOUNT_DISCOVERY_INTERVAL:-86400000}"
      ACCOUNT_DISCOVERY_BATCH_SIZE: "${ACCOUNT_DISCOVERY_BATCH_SIZE:-50}"
    command: sh -c "npm install && npx prisma generate && npm run dev"

networks:
  service_manager_network:
    driver: bridge
