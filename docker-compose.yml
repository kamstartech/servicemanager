# Production configuration
# Start with: docker compose up -d

services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: service_manager_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-Z761HPjTU6li}
      POSTGRES_DB: ${POSTGRES_DB:-fdh_service_manager}
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/initdb:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - service_manager_network

  # MSSQL Database
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: service_manager_mssql
    user: "0:0"
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "${SA_PASSWORD:-YourStrong!Passw0rd}"
      MSSQL_PID: "Developer"
      MSSQL_AGENT_ENABLED: "true"
    ports:
      - "1433:1433"
    volumes:
      - ./mssql_data:/var/opt/mssql
    healthcheck:
      test: [ "CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U SA -P '${SA_PASSWORD:-YourStrong!Passw0rd}' -Q 'SELECT 1' -No -C || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - service_manager_network

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: service_manager_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-Z761HPjTU6li}
    ports:
      - "9000:9000" # API
      - "9001:9001" # Console
    volumes:
      - ./minio_data:/data
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - service_manager_network

  # MailHog - Email Testing (Optional - disable if using production SMTP)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: service_manager_mailhog
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # Web UI
    restart: unless-stopped
    networks:
      - service_manager_network
    logging:
      driver: "none" # Disable logs to reduce noise

  # Redis for PubSub & Caching
  redis:
    image: redis:7-alpine
    container_name: service_manager_redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-R5tX6G1qFae3DYgXFOTyoysrV7jWhfFh}
    ports:
      - "6379:6379"
    volumes:
      - ./redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - service_manager_network

  # Next.js Admin Panel (production build)
  adminpanel:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: service_manager_adminpanel
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
      - ./backups:/app/backups
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - service_manager_network
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_APP_URL: "https://mobile-banking-v2.abakula.com"
      NEXT_PUBLIC_RP_ID: "mobile-banking-v2.abakula.com"
      DATABASE_URL: "postgresql://postgres:${POSTGRES_PASSWORD:-Z761HPjTU6li}@db:5432/${POSTGRES_DB:-fdh_service_manager}"
      JWT_SECRET: "${JWT_SECRET:-change-this-to-a-secure-random-string-in-production}"
      JWT_EXPIRES_IN: "${JWT_EXPIRES_IN:-24h}"
      BACKUP_DIR: "/app/backups"
      MINIO_ENDPOINT: "minio"
      MINIO_PORT: "9000"
      MINIO_USE_SSL: "false"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY:-minioadmin}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY:-Z761HPjTU6li}"
      MINIO_BUCKET_NAME: "${MINIO_BUCKET_NAME:-backups}"
      SMTP_HOST: "${SMTP_HOST:-mail.abakula.com}"
      SMTP_PORT: "${SMTP_PORT:-465}"
      SMTP_SECURE: "${SMTP_SECURE:-true}"
      SMTP_USER: "${SMTP_USER:-uat@abakula.com}"
      SMTP_PASSWORD: "${SMTP_PASSWORD:-klK@RX#;b~Vn}"
      SMTP_FROM: "${SMTP_FROM:-uat@abakula.com}"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD:-R5tX6G1qFae3DYgXFOTyoysrV7jWhfFh}"
      # T24 Configuration
      T24_BASE_URL: "${T24_BASE_URL:-https://fdh-esb.ngrok.dev}"
      T24_USERNAME: "${T24_USERNAME:-admin}"
      T24_PASSWORD: "${T24_PASSWORD:-admin}"
      # Background services
      BALANCE_SYNC_INTERVAL: "${BALANCE_SYNC_INTERVAL:-300000}"
      ACCOUNT_DISCOVERY_INTERVAL: "${ACCOUNT_DISCOVERY_INTERVAL:-86400000}"
      ACCOUNT_DISCOVERY_BATCH_SIZE: "${ACCOUNT_DISCOVERY_BATCH_SIZE:-50}"
    command: sh -c "npm install && npx prisma generate && npm run dev"

networks:
  service_manager_network:
    driver: bridge
