model FdhTransaction {
  id        String   @id @default(cuid())
  
  // Basic Identity
  reference String   @unique @db.VarChar(100)
  type      TransactionType
  source    TransactionSource @default(API)
  status    TransactionStatus @default(PENDING)

  // Transfer routing
  transferType    TransferType?      @map("transfer_type")
  transferContext MobileUserContext? @map("transfer_context")
  
  // Amount
  amount    Decimal  @db.Decimal(19, 4)
  currency  String   @default("MWK") @db.VarChar(3)
  
  // Sender (From) - Mobile Banking
  fromAccountId     Int?  @map("from_account_id")
  fromAccountNumber String?  @map("from_account_number") @db.VarChar(50)
  
  // Receiver (To) - Mobile Banking
  toAccountId       Int?  @map("to_account_id")
  toAccountNumber   String?  @map("to_account_number") @db.VarChar(50)
  
  // Description
  description       String   @db.Text
  
  // T24 Integration
  t24Reference      String?  @unique @map("t24_reference") @db.VarChar(100)
  t24Response       Json?    @map("t24_response")
  t24RequestBody    Json?    @map("t24_request_body")
  
  // Retry Mechanism (Built-in)
  retryCount        Int      @default(0) @map("retry_count")
  maxRetries        Int      @default(3) @map("max_retries")
  nextRetryAt       DateTime? @map("next_retry_at")
  lastRetryAt       DateTime? @map("last_retry_at")
  
  // Error Tracking
  errorMessage      String?  @db.Text @map("error_message")
  errorCode         String?  @db.VarChar(50) @map("error_code")
  
  // Reversal
  isReversal        Boolean  @default(false) @map("is_reversal")
  originalTxnId     String?  @unique @map("original_txn_id")
  originalTxn       FdhTransaction? @relation("Reversal", fields: [originalTxnId], references: [id], onDelete: SetNull)
  reversalTxn       FdhTransaction? @relation("Reversal")
  reversalReason    String?  @db.Text @map("reversal_reason")
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  completedAt       DateTime? @map("completed_at")
  
  // Relationships - Mobile Banking Accounts
  fromAccount MobileUserAccount? @relation("FromAccount", fields: [fromAccountId], references: [id], onDelete: SetNull)
  toAccount   MobileUserAccount? @relation("ToAccount", fields: [toAccountId], references: [id], onDelete: SetNull)
  
  // User who initiated
  initiatedByUserId Int? @map("initiated_by_user_id")
  initiatedBy       MobileUser? @relation("InitiatedBy", fields: [initiatedByUserId], references: [id], onDelete: SetNull)
  
  // Audit Trail
  statusHistory FdhTransactionStatusHistory[]
  
  // Indexes
  @@index([status, nextRetryAt])
  @@index([status, type])
  @@index([transferType])
  @@index([transferContext])
  @@index([reference])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([t24Reference])
  @@index([createdAt])
  @@map("fdh_transactions")
}

// Transaction Status History (Audit Trail)
