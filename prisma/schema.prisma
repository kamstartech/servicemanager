generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AlertStatus {
  PENDING
  SENT
  FAILED
  ACKNOWLEDGED
}

enum AlertType {
  LOW_BALANCE
  LARGE_TRANSACTION
  SUSPICIOUS_ACTIVITY
  PAYMENT_DUE
  ACCOUNT_LOGIN
}

enum ApiKeyStatus {
  ACTIVE
  SUSPENDED
  REVOKED
  EXPIRED
}

enum AttemptStatus {
  PENDING_VERIFICATION
  VERIFIED
  SUCCESS
  FAILED_CREDENTIALS
  FAILED_OTP
  FAILED_DEVICE_PENDING
  FAILED_DEVICE_BLOCKED
  EXPIRED
  PENDING_APPROVAL
}

enum AttemptType {
  PASSWORD_LOGIN
  PASSKEY_REGISTRATION
  PASSKEY_LOGIN
  OTP_VERIFY
}

enum BeneficiaryType {
  WALLET
  BANK_INTERNAL
  BANK_EXTERNAL
}

enum BillerTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REVERSED
}

enum BillerTransactionType {
  ACCOUNT_DETAILS
  POST_TRANSACTION
  GET_INVOICE
  CONFIRM_INVOICE
  BUNDLE_DETAILS
  CONFIRM_BUNDLE
}

enum BillerType {
  REGISTER_GENERAL
  BWB_POSTPAID
  LWB_POSTPAID
  SRWB_POSTPAID
  SRWB_PREPAID
  MASM
  AIRTEL_VALIDATION
  TNM_BUNDLES
}

enum CheckbookRequestStatus {
  PENDING
  APPROVED
  READY_FOR_COLLECTION
  COLLECTED
  CANCELLED
  REJECTED
}

enum CoreBankingAuthType {
  BASIC
  BEARER
}

enum LoginAlertMode {
  EVERY_LOGIN
  NEW_DEVICE
  NEW_LOCATION
}

enum LoginMethod {
  PASSWORD
  BIOMETRIC
  PASSKEY
  OTP
}

enum MigrationStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum MobileUserContext {
  MOBILE_BANKING
  WALLET
  VILLAGE_BANKING
  AGENT
  MERCHANT
}

enum NotificationChannel {
  PUSH
  SMS
  EMAIL
}

enum PaymentReminderInterval {
  ONE_WEEK
  THREE_DAYS
  ONE_DAY
}

enum PaymentType {
  BILL
  LOAN
  SUBSCRIPTION
  RECURRING
}

enum RegistrationSource {
  THIRD_PARTY_API
  ADMIN_PORTAL
  SELF_SERVICE
  T24_SYNC
}

enum RegistrationStatus {
  PENDING
  APPROVED
  COMPLETED
  FAILED
  DUPLICATE
}

enum ResolutionAction {
  CONFIRMED_LEGITIMATE
  FRAUD_REPORTED
  ACCOUNT_LOCKED
}

enum StepExecutionMode {
  CLIENT_ONLY // No backend trigger
  SERVER_SYNC // Wait for server response
  SERVER_ASYNC // Fire and forget
  SERVER_VALIDATION // Validate on server
}

enum SuspicionReason {
  UNUSUAL_LOCATION
  MULTIPLE_FAILED_ATTEMPTS
  NEW_DEVICE_TRANSACTION
}

enum TransactionSource {
  MOBILE_BANKING
  WALLET
  ADMIN
  API
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  FAILED_PERMANENT
  REVERSED
}

enum TransactionType {
  DEBIT
  CREDIT
  TRANSFER
  WALLET_TRANSFER
  WALLET_DEBIT
  WALLET_CREDIT
  ACCOUNT_TO_WALLET
  WALLET_TO_ACCOUNT
}

enum TriggerTiming {
  BEFORE_STEP // Execute before showing step
  AFTER_STEP // Execute after user completes step
  BOTH // Execute before AND after
}

enum UserAction {
  DISMISSED
  THIS_WAS_ME
  REPORT_FRAUD
  QUICK_PAY
}

enum WorkflowExecutionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum WorkflowStepType {
  FORM
  API_CALL
  VALIDATION
  CONFIRMATION
  DISPLAY
  REDIRECT
}



model AccountAlert {
  id            Int       @id @default(autoincrement())
  mobileUserId  Int       @map("mobile_user_id")
  accountNumber String?   @map("account_number") @db.VarChar(20)
  alertType     AlertType @map("alert_type")

  // Alert Context (flexible JSON storage)
  alertData Json @map("alert_data")

  // Status
  status AlertStatus @default(PENDING)

  // Delivery Tracking
  channelsSent   NotificationChannel[] @default([]) @map("channels_sent")
  sentAt         DateTime?             @map("sent_at")
  deliveryStatus Json?                 @map("delivery_status")

  // User Interaction
  acknowledgedAt DateTime?   @map("acknowledged_at")
  userAction     UserAction? @map("user_action")

  // Timestamps
  triggeredAt DateTime @default(now()) @map("triggered_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  mobileUser           MobileUser              @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)
  suspiciousActivities SuspiciousActivityLog[]

  @@index([mobileUserId])
  @@index([accountNumber])
  @@index([alertType])
  @@index([status])
  @@index([triggeredAt])
  @@map("account_alerts")
}

model AccountAlertSettings {
  id            Int    @id @default(autoincrement())
  mobileUserId  Int    @map("mobile_user_id")
  accountNumber String @map("account_number") @db.VarChar(20)

  // Low Balance Alert
  lowBalanceEnabled   Boolean               @default(true) @map("low_balance_enabled")
  lowBalanceThreshold Decimal?              @map("low_balance_threshold") @db.Decimal(19, 4)
  lowBalanceChannels  NotificationChannel[] @default([PUSH]) @map("low_balance_channels")

  // Large Transaction Alert
  largeTransactionEnabled   Boolean               @default(true) @map("large_transaction_enabled")
  largeTransactionThreshold Decimal?              @map("large_transaction_threshold") @db.Decimal(19, 4)
  largeTransactionChannels  NotificationChannel[] @default([PUSH, SMS]) @map("large_transaction_channels")
  largeTransactionDebitOnly Boolean               @default(true) @map("large_transaction_debit_only")

  // Suspicious Activity Alert
  alertUnusualLocation        Boolean               @default(true) @map("alert_unusual_location")
  alertMultipleFailedAttempts Boolean               @default(true) @map("alert_multiple_failed_attempts")
  alertNewDeviceTransaction   Boolean               @default(true) @map("alert_new_device_transaction")
  suspiciousActivityChannels  NotificationChannel[] @default([PUSH, SMS, EMAIL]) @map("suspicious_activity_channels")

  // Payment Due Alert
  paymentDueEnabled       Boolean                 @default(true) @map("payment_due_enabled")
  paymentDueChannels      NotificationChannel[]   @default([PUSH, SMS]) @map("payment_due_channels")
  paymentReminderInterval PaymentReminderInterval @default(ONE_DAY) @map("payment_reminder_interval")

  // Login Alert
  loginAlertMode     LoginAlertMode        @default(NEW_DEVICE) @map("login_alert_mode")
  loginAlertChannels NotificationChannel[] @default([PUSH, EMAIL]) @map("login_alert_channels")

  // Quiet Hours
  quietHoursEnabled Boolean   @default(false) @map("quiet_hours_enabled")
  quietHoursStart   DateTime? @map("quiet_hours_start") @db.Time(6)
  quietHoursEnd     DateTime? @map("quiet_hours_end") @db.Time(6)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mobileUser MobileUser @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)

  @@unique([mobileUserId, accountNumber])
  @@index([mobileUserId])
  @@index([accountNumber])
  @@map("account_alert_settings")
}

model AccountCategory {
  id              Int      @id @default(autoincrement())
  category        String   @unique @db.Text
  displayToMobile Boolean  @default(true) @map("display_to_mobile")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("fdh_account_categories")
}

model AdminWebPasskey {
  id                String    @id @default(cuid())
  userId            Int       @map("user_id")
  credentialId      String    @unique @map("credential_id") @db.Text
  publicKey         String    @map("public_key") @db.Text
  counter           BigInt    @default(0)
  deviceName        String?   @map("device_name") @db.Text
  transports        String[]  @default([])
  backupEligible    Boolean   @default(false) @map("backup_eligible")
  backupState       Boolean   @default(false) @map("backup_state")
  attestationFormat String?   @map("attestation_format") @db.Text
  aaguid            String?   @db.Text
  lastUsedAt        DateTime? @map("last_used_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  user AdminWebUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("admin_web_passkeys")
}

model AdminWebPasswordResetToken {
  id        Int       @id @default(autoincrement())
  token     String    @unique @db.Text
  expiresAt DateTime
  usedAt    DateTime?

  userId Int          @map("user_id")
  user   AdminWebUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("admin_web_password_reset_tokens")
}

model AdminWebUser {
  id           Int      @id @default(autoincrement())
  email        String   @unique @db.Text
  passwordHash String   @db.Text
  name         String?  @db.Text
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  resetTokens            AdminWebPasswordResetToken[]
  processedRegistrations RequestedRegistration[]
  approvedCheckbooks     CheckbookRequest[]
  passkeys               AdminWebPasskey[]

  @@map("admin_web_users")
}

model AppScreen {
  id      String            @id @default(cuid())
  name    String            @db.Text
  context MobileUserContext
  icon    String            @db.Text // Icon name from predefined list
  order   Int               @default(0)

  isActive  Boolean @default(true) @map("is_active")
  isTesting Boolean @default(false) @map("is_testing")

  pages AppScreenPage[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([context, name])
  @@index([context])
  @@index([order])
  @@index([isActive])
  @@map("app_screens")
}

model AppScreenPage {
  id    String @id @default(cuid())
  name  String @db.Text
  icon  String @db.Text
  order Int    @default(0)

  isActive  Boolean @default(true) @map("is_active")
  isTesting Boolean @default(false) @map("is_testing")

  screenId String    @map("screen_id")
  screen   AppScreen @relation(fields: [screenId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workflows AppScreenPageWorkflow[]

  @@unique([screenId, name])
  @@index([screenId])
  @@index([order])
  @@index([isActive])
  @@map("app_screen_pages")
}

model AppScreenPageWorkflow {
  id String @id @default(cuid())

  pageId     String @map("page_id")
  workflowId String @map("workflow_id")

  order    Int     @default(0)
  isActive Boolean @default(true) @map("is_active")

  // Override config if needed (optional)
  configOverride Json? @map("config_override")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  page     AppScreenPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  workflow Workflow      @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([pageId, workflowId])
  @@index([pageId])
  @@index([workflowId])
  @@index([order])
  @@map("app_screen_page_workflows")
}

// ============================================
// Billers System
// ============================================

model Backup {
  id         String   @id @default(cuid())
  filename   String   @unique
  sizeBytes  BigInt   @map("size_bytes")
  storageUrl String?  @map("storage_url") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("fdh_backups")
}

model BackupSchedule {
  id Int @id

  enabled  Boolean @default(false)
  time     String  @default("02:00") @db.VarChar(5)
  timeZone String  @default("UTC") @map("time_zone") @db.Text

  isRunning Boolean @default(false) @map("is_running")

  lastRunAt DateTime? @map("last_run_at")
  lastRunDate String? @map("last_run_date") @db.VarChar(10)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("backup_schedule")
}

model Beneficiary {
  id Int @id @default(autoincrement())

  // Relationship to user
  userId Int        @map("user_id")
  user   MobileUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Beneficiary details
  name            String          @db.Text
  beneficiaryType BeneficiaryType @map("beneficiary_type")

  // For WALLET beneficiaries
  phoneNumber String? @map("phone_number") @db.Text

  // For BANK_INTERNAL and BANK_EXTERNAL beneficiaries
  accountNumber String? @map("account_number") @db.Text

  // For BANK_EXTERNAL only
  bankCode String? @map("bank_code") @db.Text
  bankName String? @map("bank_name") @db.Text
  branch   String? @db.Text

  // Optional fields
  description String? @db.Text

  // Metadata
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Unique constraints per type
  @@unique([userId, phoneNumber, beneficiaryType], name: "unique_user_wallet")
  @@unique([userId, accountNumber, beneficiaryType], name: "unique_user_internal_bank")
  @@unique([userId, accountNumber, bankCode, beneficiaryType], name: "unique_user_external_bank")
  @@index([userId])
  @@index([beneficiaryType])
  @@map("fdh_beneficiaries")
}

model BillerConfig {
  id String @id @default(cuid())

  // Identity
  billerType  BillerType @unique @map("biller_type")
  billerName  String     @map("biller_name") @db.Text
  displayName String     @map("display_name") @db.Text
  description String?    @db.Text
  isActive    Boolean    @default(true) @map("is_active")

  // API Configuration
  baseUrl        String @map("base_url") @db.Text
  endpoints      Json // { accountDetails, payment, invoice, etc. }
  authentication Json? // Encrypted credentials

  // Transaction Settings
  defaultCurrency     String   @default("MWK") @map("default_currency") @db.VarChar(3)
  supportedCurrencies String[] @default(["MWK"]) @map("supported_currencies")
  timeoutMs           Int      @default(30000) @map("timeout_ms")
  retryAttempts       Int      @default(3) @map("retry_attempts")

  // Features & Validation
  features        Json // { supportsInvoice, supportsBalanceCheck, etc. }
  validationRules Json // { accountNumberFormat, minAmount, maxAmount }

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Relations
  transactions BillerTransaction[]

  @@index([billerType])
  @@index([isActive])
  @@map("biller_configs")
}

model BillerTransaction {
  id String @id @default(cuid())

  // Biller Reference
  billerConfigId String?       @map("biller_config_id")
  billerConfig   BillerConfig? @relation(fields: [billerConfigId], references: [id])
  billerType     BillerType    @map("biller_type")
  billerName     String        @map("biller_name") @db.Text

  // Transaction Identity
  ourTransactionId      String  @unique @map("our_transaction_id") @db.VarChar(50)
  externalTransactionId String? @map("external_transaction_id") @db.Text

  // Transaction Type
  transactionType BillerTransactionType @map("transaction_type")

  // Account Information
  accountNumber       String  @map("account_number") @db.Text
  accountType         String? @map("account_type") @db.VarChar(20)
  customerAccountName String? @map("customer_account_name") @db.Text

  // T24 Integration
  creditAccount     String? @map("credit_account") @db.VarChar(20)
  creditAccountType String? @map("credit_account_type") @db.VarChar(20)
  debitAccount      String? @map("debit_account") @db.VarChar(20)
  debitAccountType  String? @map("debit_account_type") @db.VarChar(20)

  // Amount
  amount   Decimal @db.Decimal(18, 2)
  currency String  @default("MWK") @db.VarChar(3)

  // Status & Processing
  status BillerTransactionStatus

  // API Details
  apiEndpoint     String? @map("api_endpoint") @db.Text
  requestPayload  Json?   @map("request_payload")
  responsePayload Json?   @map("response_payload")
  errorMessage    String? @map("error_message") @db.Text
  errorCode       String? @map("error_code") @db.VarChar(50)

  // Special Fields
  bundleId      String? @map("bundle_id") @db.VarChar(50)
  invoiceNumber String? @map("invoice_number") @db.VarChar(100)
  meterNumber   String? @map("meter_number") @db.VarChar(50)

  // Metadata
  metadata Json? // Additional context

  // Timestamps
  processedAt DateTime? @map("processed_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Audit
  initiatedBy String? @map("initiated_by")

  @@index([billerType])
  @@index([status])
  @@index([ourTransactionId])
  @@index([accountNumber])
  @@index([createdAt])
  @@index([billerConfigId])
  @@map("biller_transactions")
}

// ============================================
// Third-Party API Access Management
// ============================================

model CheckbookRequest {
  id            Int    @id @default(autoincrement())
  mobileUserId  Int    @map("mobile_user_id")
  accountNumber String @map("account_number") @db.Text

  // Checkbook details
  numberOfCheckbooks Int    @default(1) @map("number_of_checkbooks")
  collectionPoint    String @map("collection_point") @db.Text

  // Status tracking
  status      CheckbookRequestStatus @default(PENDING)
  requestedAt DateTime               @default(now()) @map("requested_at")
  approvedAt  DateTime?              @map("approved_at")
  approvedBy  Int?                   @map("approved_by")
  readyAt     DateTime?              @map("ready_at")
  collectedAt DateTime?              @map("collected_at")
  cancelledAt DateTime?              @map("cancelled_at")
  rejectedAt  DateTime?              @map("rejected_at")

  // Additional information
  notes           String? @db.Text
  rejectionReason String? @map("rejection_reason") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mobileUser     MobileUser    @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)
  approvedByUser AdminWebUser? @relation(fields: [approvedBy], references: [id], onDelete: SetNull)

  @@index([mobileUserId])
  @@index([accountNumber])
  @@index([status])
  @@index([requestedAt])
  @@map("checkbook_requests")
}

model CoreBankingConnection {
  id       Int    @id @default(autoincrement())
  name     String
  username String @db.Text
  password String @db.Text
  baseUrl  String @db.Text // e.g. "https://core-banking.internal" or full base API URL

  authType CoreBankingAuthType @default(BASIC)
  token    String?             @db.Text

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lastTestedAt    DateTime?
  lastTestOk      Boolean?
  lastTestMessage String?

  endpoints CoreBankingEndpoint[]
}

model CoreBankingEndpoint {
  id           Int                   @id @default(autoincrement())
  connection   CoreBankingConnection @relation(fields: [connectionId], references: [id])
  connectionId Int

  name         String
  method       String  @default("POST")
  path         String  @db.Text
  bodyTemplate String? @db.Text
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DatabaseConnection {
  id         Int      @id @default(autoincrement())
  name       String
  engine     String // e.g. "postgres" (v1 only)
  host       String
  port       Int
  database   String
  username   String
  password   String
  options    Json?
  isReadOnly Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  lastTestedAt    DateTime?
  lastTestOk      Boolean?
  lastTestMessage String?

  migrations Migration[]
}

model DeviceLoginAttempt {
  id String @id @default(cuid())

  // User Context
  mobileUserId Int?    @map("mobile_user_id")
  username     String? @db.Text
  context      String? @db.Text

  // Device Information (NOT yet in device table)
  deviceId    String? @map("device_id")
  deviceName  String? @map("device_name")
  deviceModel String? @map("device_model")
  deviceOs    String? @map("device_os")

  // Network Context
  ipAddress String? @map("ip_address")
  location  String? @db.Text

  // Attempt Details
  attemptType   AttemptType   @map("attempt_type")
  status        AttemptStatus
  failureReason String?       @map("failure_reason") @db.Text

  // OTP Verification
  otpCode           String?   @map("otp_code")
  otpSentTo         String?   @map("otp_sent_to")
  otpSentAt         DateTime? @map("otp_sent_at")
  otpExpiresAt      DateTime? @map("otp_expires_at")
  otpVerifiedAt     DateTime? @map("otp_verified_at")
  otpAttempts       Int       @default(0) @map("otp_attempts")
  verificationToken String?   @unique @map("verification_token")

  attemptedAt DateTime @default(now()) @map("attempted_at")

  // Relations
  mobileUser MobileUser? @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)

  @@index([mobileUserId])
  @@index([deviceId])
  @@index([verificationToken])
  @@index([attemptedAt])
  @@map("fdh_device_login_attempts")
}

model DeviceSession {
  id           String @id @default(cuid())
  deviceId     String @map("device_id")
  mobileUserId Int    @map("mobile_user_id")

  // Token tracking
  tokenHash String @unique @db.Text
  sessionId String @unique @map("session_id") @db.Text

  // Session info
  isActive       Boolean  @default(true) @map("is_active")
  expiresAt      DateTime @map("expires_at")
  lastActivityAt DateTime @default(now()) @map("last_activity_at")

  // Context
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent") @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  mobileUser MobileUser @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([mobileUserId])
  @@index([tokenHash])
  @@index([sessionId])
  @@index([isActive])
  @@map("fdh_device_sessions")
}

model FdhTransaction {
  id        String   @id @default(cuid())
  
  // Basic Identity
  reference String   @unique @db.VarChar(100)
  type      TransactionType
  source    TransactionSource @default(API)
  status    TransactionStatus @default(PENDING)
  
  // Amount
  amount    Decimal  @db.Decimal(19, 4)
  currency  String   @default("MWK") @db.VarChar(3)
  
  // Sender (From) - Mobile Banking
  fromAccountId     Int?  @map("from_account_id")
  fromAccountNumber String?  @map("from_account_number") @db.VarChar(50)
  
  // Sender (From) - Wallet (MobileUser with context=WALLET)
  fromWalletId      Int?  @map("from_wallet_id")
  fromWalletNumber  String?  @map("from_wallet_number") @db.VarChar(20)
  
  // Receiver (To) - Mobile Banking
  toAccountId       Int?  @map("to_account_id")
  toAccountNumber   String?  @map("to_account_number") @db.VarChar(50)
  
  // Receiver (To) - Wallet
  toWalletId        Int?  @map("to_wallet_id")
  toWalletNumber    String?  @map("to_wallet_number") @db.VarChar(20)
  
  // Description
  description       String   @db.Text
  
  // T24 Integration
  t24Reference      String?  @unique @map("t24_reference") @db.VarChar(100)
  t24Response       Json?    @map("t24_response")
  t24RequestBody    Json?    @map("t24_request_body")
  
  // Retry Mechanism (Built-in)
  retryCount        Int      @default(0) @map("retry_count")
  maxRetries        Int      @default(3) @map("max_retries")
  nextRetryAt       DateTime? @map("next_retry_at")
  lastRetryAt       DateTime? @map("last_retry_at")
  
  // Error Tracking
  errorMessage      String?  @db.Text @map("error_message")
  errorCode         String?  @db.VarChar(50) @map("error_code")
  
  // Reversal
  isReversal        Boolean  @default(false) @map("is_reversal")
  originalTxnId     String?  @unique @map("original_txn_id")
  originalTxn       FdhTransaction? @relation("Reversal", fields: [originalTxnId], references: [id], onDelete: SetNull)
  reversalTxn       FdhTransaction? @relation("Reversal")
  reversalReason    String?  @db.Text @map("reversal_reason")
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  completedAt       DateTime? @map("completed_at")
  
  // Relationships - Mobile Banking Accounts
  fromAccount MobileUserAccount? @relation("FromAccount", fields: [fromAccountId], references: [id], onDelete: SetNull)
  toAccount   MobileUserAccount? @relation("ToAccount", fields: [toAccountId], references: [id], onDelete: SetNull)
  
  // Relationships - Wallets (MobileUser with context=WALLET)
  fromWallet  MobileUser? @relation("FromWallet", fields: [fromWalletId], references: [id], onDelete: SetNull)
  toWallet    MobileUser? @relation("ToWallet", fields: [toWalletId], references: [id], onDelete: SetNull)
  
  // User who initiated
  initiatedByUserId Int? @map("initiated_by_user_id")
  initiatedBy       MobileUser? @relation("InitiatedBy", fields: [initiatedByUserId], references: [id], onDelete: SetNull)
  
  // Audit Trail
  statusHistory FdhTransactionStatusHistory[]
  
  // Indexes
  @@index([status, nextRetryAt])
  @@index([status, type])
  @@index([reference])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([fromWalletId])
  @@index([toWalletId])
  @@index([t24Reference])
  @@index([createdAt])
  @@map("fdh_transactions")
}

// Transaction Status History (Audit Trail)

model FdhTransactionStatusHistory {
  id            String   @id @default(cuid())
  
  transactionId String   @map("transaction_id")
  transaction   FdhTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  fromStatus    TransactionStatus @map("from_status")
  toStatus      TransactionStatus @map("to_status")
  
  reason        String?  @db.Text
  retryNumber   Int?     @map("retry_number")
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  @@index([transactionId])
  @@index([toStatus, createdAt])
  @@map("fdh_transaction_status_history")
}

// SMS Notifications Model

model Form {
  id          String  @id @default(cuid())
  name        String  @db.Text
  description String? @db.Text
  category    String? @db.Text

  // JSON schema for fields
  schema Json

  // Settings
  isActive Boolean @default(true) @map("is_active")

  // Metadata
  createdBy Int @map("created_by")
  version   Int @default(1)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([category])
  @@map("forms")
}

model Migration {
  id          Int     @id @default(autoincrement())
  name        String
  description String? @db.Text

  // Source database (external - where we read from)
  sourceConnectionId Int
  sourceConnection   DatabaseConnection @relation(fields: [sourceConnectionId], references: [id], onDelete: Cascade)
  sourceQuery        String             @db.Text

  // Target database (our database - where we write to)
  targetTable       String
  targetInsertQuery String @db.Text // Template query with placeholders

  // Execution tracking
  status              MigrationStatus @default(PENDING)
  lastRunAt           DateTime?
  lastRunSuccess      Boolean?
  lastRunMessage      String?         @db.Text
  lastRunRowsAffected Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Scheduling
  isRecurring    Boolean   @default(false) @map("is_recurring") // Run periodically?
  cronExpression String?   @map("cron_expression") @db.Text // e.g. "0 0 * * *"
  nextRunAt      DateTime? @map("next_run_at") // When is it due next?

  @@map("fdh_migrations")
}

model MobileDevice {
  id           String     @id @default(cuid())
  mobileUserId Int        @map("mobile_user_id")
  user         MobileUser @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)

  // Device Metadata
  name     String? @db.Text
  model    String? @db.Text
  os       String? @db.Text
  deviceId String  @db.Text

  // Passkey Credentials (WebAuthn) - Optional for password-login devices
  credentialId String?  @unique @db.Text
  publicKey    String?  @db.Text
  counter      BigInt?  @default(0)
  transports   String[] @default([])

  // Verification Context
  verifiedVia          String? @map("verified_via") // "OTP_SMS", "OTP_EMAIL", "PASSKEY", "ADMIN"
  verificationIp       String? @map("verification_ip")
  verificationLocation String? @map("verification_location")

  // Push Notification (FCM)
  fcmToken          String?   @map("fcm_token") @db.Text
  fcmTokenUpdatedAt DateTime? @map("fcm_token_updated_at")
  pushEnabled       Boolean   @default(true) @map("push_enabled")

  // Status
  isActive    Boolean   @default(true) @map("is_active")
  isPrimary   Boolean   @default(false) @map("is_primary")
  lastUsedAt  DateTime? @map("last_used_at")
  loginCount  Int       @default(0) @map("login_count")
  lastLoginIp String?   @map("last_login_ip")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([mobileUserId, deviceId])
  @@index([mobileUserId])
  @@index([fcmToken])
  @@map("mobile_devices")
}

model MobileUser {
  id      Int               @id @default(autoincrement())
  context MobileUserContext

  // Login identifiers (only some are used depending on context)
  username    String? @db.Text
  phoneNumber String? @db.Text

  // Core banking linkage
  customerNumber String? @db.Text
  accountNumber  String? @db.Text // Deprecated: use accounts relation

  // Secrets (storage/validation rules depend on context)
  passwordHash String? @db.Text
  secretHash   String? @map("secret") @db.Text
  memoWord     String? @map("memo_word") @db.Text // Security word for password reset

  // Token versioning for rotation
  tokenVersion Int @default(0) @map("token_version")

  smsNotifications   Boolean @default(true) @map("sms_notifications")
  emailNotifications Boolean @default(true) @map("email_notifications")
  pushNotifications  Boolean @default(true) @map("push_notifications")

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  beneficiaries        Beneficiary[]
  devices              MobileDevice[]
  accounts             MobileUserAccount[]
  loginAttempts        DeviceLoginAttempt[]
  profile              MobileUserProfile?
  sessions             DeviceSession[]
  registrationRequests RequestedRegistration[]
  alertSettings        AccountAlertSettings[]
  alerts               AccountAlert[]
  suspiciousActivities SuspiciousActivityLog[]
  checkbookRequests    CheckbookRequest[]
  kyc                  MobileUserKYC?
  
  // Transaction relationships (for wallet context)
  outgoingWalletTransactions FdhTransaction[] @relation("FromWallet")
  incomingWalletTransactions FdhTransaction[] @relation("ToWallet")
  initiatedTransactions      FdhTransaction[] @relation("InitiatedBy")

  @@map("fdh_mobile_users")
}

model MobileUserAccount {
  id           Int @id @default(autoincrement())
  mobileUserId Int @map("mobile_user_id")

  // Context to distinguish between WALLET and MOBILE_BANKING accounts
  context MobileUserContext @default(MOBILE_BANKING)

  accountNumber String  @map("account_number") @db.Text
  accountName   String? @map("account_name") @db.Text
  accountType   String? @map("account_type") @db.Text // SAVINGS, CURRENT, WALLET, etc.
  currency      String  @default("MWK")

  // Account details from T24 (for MOBILE_BANKING context)
  categoryId    String? @map("category_id") @db.Text // e.g., "1001"
  categoryName  String? @map("category_name") @db.Text // e.g., "Platinum Current Account"
  accountStatus String? @map("account_status") @db.Text // e.g., "Active"
  holderName    String? @map("holder_name") @db.Text // Account holder name
  nickName      String? @map("nick_name") @db.Text // Account nickname
  onlineLimit   String? @map("online_limit") @db.Text // Online transaction limit
  openingDate   String? @map("opening_date") @db.Text // Account opening date

  // Balance fields (synced from T24 for MOBILE_BANKING, managed locally for WALLET)
  balance          Decimal? @db.Decimal(15, 2)
  workingBalance   Decimal? @map("working_balance") @db.Decimal(15, 2)
  availableBalance Decimal? @map("available_balance") @db.Decimal(15, 2)
  clearedBalance   Decimal? @map("cleared_balance") @db.Decimal(15, 2)

  // Wallet-specific fields (only used when context = WALLET)
  frozen              Boolean   @default(false)
  locked              Boolean   @default(false)
  blocked             Boolean   @default(false)
  lastTransactionDate DateTime? @map("last_transaction_date")

  isPrimary Boolean @default(false) @map("is_primary")
  isActive  Boolean @default(true) @map("is_active")
  isHidden  Boolean @default(false) @map("is_hidden")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mobileUser MobileUser @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)
  
  // Transaction relationships (for mobile banking accounts)
  outgoingTransactions FdhTransaction[] @relation("FromAccount")
  incomingTransactions FdhTransaction[] @relation("ToAccount")

  @@unique([mobileUserId, accountNumber, context])
  @@index([mobileUserId])
  @@index([context])
  @@map("fdh_mobile_user_accounts")
}

model MobileUserKYC {
  id           Int @id @default(autoincrement())
  mobileUserId Int @unique @map("mobile_user_id")

  // Wallet Tier Assignment (only for WALLET context users)
  walletTierId Int? @map("wallet_tier_id")

  // KYC Fields
  dateOfBirth   DateTime? @map("date_of_birth") @db.Date
  occupation    String?   @db.Text
  employerName  String?   @map("employer_name") @db.Text
  sourceOfFunds String?   @map("source_of_funds") @db.Text
  idNumber      String?   @map("id_number") @db.Text
  idImage       String?   @map("id_image") @db.Text

  // KYC Status
  kycComplete   Boolean   @default(false) @map("kyc_complete")
  kycVerifiedAt DateTime? @map("kyc_verified_at")

  // NRB Validation
  nrbValidation      Boolean? @map("nrb_validation")
  nrbResponseCode    Int?     @map("nrb_response_code")
  nrbResponseMessage String?  @map("nrb_response_message") @db.Text
  nrbStatus          String?  @map("nrb_status") @db.Text
  nrbStatusReason    String?  @map("nrb_status_reason") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mobileUser MobileUser  @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)
  walletTier WalletTier? @relation(fields: [walletTierId], references: [id])

  @@index([mobileUserId])
  @@index([walletTierId])
  @@map("fdh_mobile_user_kyc")
}

// ============================================
// TRANSACTION SYSTEM (PROXY)
// ============================================

// Unified Transaction Model (Proxy for T24)

model MobileUserProfile {
  id           Int @id @default(autoincrement())
  mobileUserId Int @unique @map("mobile_user_id")

  firstName String? @map("first_name") @db.Text
  lastName  String? @map("last_name") @db.Text
  email     String? @db.Text
  phone     String? @db.Text
  address   String? @db.Text
  city      String? @db.Text
  country   String? @db.Text
  zip       String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mobileUser MobileUser @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)

  @@map("fdh_mobile_user_profiles")
}

model RequestedRegistration {
  id Int @id @default(autoincrement())

  // Request metadata
  sourceIp    String             @map("source_ip") @db.Text
  requestBody Json               @map("request_body") // Full request payload
  source      RegistrationSource @default(THIRD_PARTY_API)

  // Customer data (extracted from request)
  phoneNumber    String  @map("phone_number") @db.Text
  customerNumber String  @map("customer_number") @db.Text
  emailAddress   String? @map("email_address") @db.Text
  firstName      String? @map("first_name") @db.Text
  lastName       String? @map("last_name") @db.Text
  profileType    String? @map("profile_type") @db.Text
  company        String? @db.Text

  // Processing status
  status       RegistrationStatus @default(PENDING)
  processedAt  DateTime?          @map("processed_at")
  elixirUserId Int?               @map("elixir_user_id") // ID from service_manager
  mobileUserId Int?               @map("mobile_user_id") // Link to MobileUser if created

  // Error handling
  errorMessage String?   @map("error_message") @db.Text
  retryCount   Int       @default(0) @map("retry_count")
  lastRetryAt  DateTime? @map("last_retry_at")

  // Validation data (stored for cron job processing)
  validationData Json? @map("validation_data")

  // Process stage tracking
  processLog Json[] @default([]) @map("process_log")

  // Audit trail
  processedBy Int?    @map("processed_by") // AdminWebUser who processed
  notes       String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mobileUser      MobileUser?   @relation(fields: [mobileUserId], references: [id], onDelete: SetNull)
  processedByUser AdminWebUser? @relation(fields: [processedBy], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([customerNumber])
  @@index([phoneNumber])
  @@index([sourceIp])
  @@index([createdAt])
  @@index([source])
  @@map("requested_registrations")
}

// ============================================
// Account Alerts System
// ============================================

model SMSNotification {
  id           Int       @id @default(autoincrement())
  userId       Int       @default(1) @map("user_id")
  msisdn       String    // Phone number
  message      String    @db.Text
  status       String    @default("ready")
  sentAt       DateTime? @map("sent_at")
  details      Json?     // Provider response and metadata
  attemptCount Int       @default(0) @map("attempt_count")
  
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  
  @@index([status, attemptCount])
  @@index([userId])
  @@index([createdAt])
  @@map("sms_notifications")
}

model SuspiciousActivityLog {
  id            Int     @id @default(autoincrement())
  alertId       Int?    @map("alert_id")
  mobileUserId  Int     @map("mobile_user_id")
  accountNumber String? @map("account_number") @db.VarChar(20)

  // Detection Details
  suspicionReason  SuspicionReason @map("suspicion_reason")
  riskScore        Int             @map("risk_score")
  detectionDetails Json            @map("detection_details")

  // Related Data
  relatedTransactionIds String[] @default([]) @map("related_transaction_ids")
  deviceId              String?  @map("device_id") @db.VarChar(255)
  ipAddress             String?  @map("ip_address") @db.VarChar(45)
  location              String?  @db.VarChar(255)

  // Resolution
  isResolved       Boolean           @default(false) @map("is_resolved")
  resolvedAt       DateTime?         @map("resolved_at")
  resolutionAction ResolutionAction? @map("resolution_action")
  adminNotes       String?           @map("admin_notes") @db.Text

  detectedAt DateTime @default(now()) @map("detected_at")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  alert      AccountAlert? @relation(fields: [alertId], references: [id], onDelete: SetNull)
  mobileUser MobileUser    @relation(fields: [mobileUserId], references: [id], onDelete: Cascade)

  @@index([mobileUserId])
  @@index([alertId])
  @@index([riskScore])
  @@index([isResolved])
  @@index([detectedAt])
  @@map("suspicious_activity_log")
}

// ============================================
// Checkbook Requests
// ============================================

model ThirdPartyAccessLog {
  id       String  @id @default(cuid())
  clientId String  @map("client_id")
  apiKeyId String? @map("api_key_id")

  // Request details
  method       String @db.VarChar(10) // GET, POST, etc.
  endpoint     String @db.Text
  statusCode   Int    @map("status_code")
  responseTime Int?   @map("response_time") // milliseconds

  // Client info
  ipAddress String  @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent") @db.Text

  // Request/Response (optional - for debugging)
  requestBody  Json?   @map("request_body")
  responseBody Json?   @map("response_body")
  errorMessage String? @map("error_message") @db.Text

  // Timestamp
  requestedAt DateTime @default(now()) @map("requested_at")

  // Relations
  client ThirdPartyClient  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  apiKey ThirdPartyApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([apiKeyId])
  @@index([requestedAt])
  @@index([endpoint])
  @@index([statusCode])
  @@map("third_party_access_logs")
}

// ============================================
// Wallet Tiers System
// ============================================

model ThirdPartyApiKey {
  id       String @id @default(cuid())
  clientId String @map("client_id")

  // API Key (hashed)
  keyHash   String @unique @map("key_hash") @db.Text
  keyPrefix String @map("key_prefix") @db.VarChar(50) // First 50 chars for display

  // Key metadata
  name        String?      @db.Text // e.g., "Production Key", "Testing Key"
  description String?      @db.Text
  status      ApiKeyStatus @default(ACTIVE)

  // Permissions (JSON array of allowed endpoints/actions)
  permissions Json @default("[]") // e.g., ["registrations:read", "registrations:create"]

  // Expiration
  expiresAt DateTime? @map("expires_at")

  // Usage tracking
  lastUsedAt DateTime? @map("last_used_at")
  usageCount Int       @default(0) @map("usage_count")

  // Audit
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  createdBy Int?      @map("created_by") // AdminWebUser ID
  revokedAt DateTime? @map("revoked_at")
  revokedBy Int?      @map("revoked_by") // AdminWebUser ID

  // Relations
  client     ThirdPartyClient      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  accessLogs ThirdPartyAccessLog[]

  @@index([clientId])
  @@index([status])
  @@index([keyHash])
  @@map("third_party_api_keys")
}

model ThirdPartyClient {
  id          String  @id @default(cuid())
  name        String  @db.Text // e.g., "External Registration System"
  description String? @db.Text

  // Contact information
  contactName  String? @map("contact_name") @db.Text
  contactEmail String? @map("contact_email") @db.Text
  contactPhone String? @map("contact_phone") @db.Text

  // API Access
  isActive Boolean @default(true) @map("is_active")

  // IP Whitelisting (optional)
  allowedIps String[] @default([]) @map("allowed_ips")

  // Rate limiting
  rateLimitPerMinute Int @default(60) @map("rate_limit_per_minute")
  rateLimitPerHour   Int @default(1000) @map("rate_limit_per_hour")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy Int?     @map("created_by") // AdminWebUser ID

  // Relations
  apiKeys    ThirdPartyApiKey[]
  accessLogs ThirdPartyAccessLog[]

  @@index([isActive])
  @@map("third_party_clients")
}

model WalletTier {
  id Int @id @default(autoincrement())

  // Basic Info
  name        String  @db.Text
  description String? @db.Text
  position    Int // Hierarchy: 1, 2, 3, etc.
  isDefault   Boolean @default(false) @map("is_default")

  // Balance Limits
  minimumBalance     Decimal @default(0) @map("minimum_balance") @db.Decimal(15, 2)
  maximumBalance     Decimal @map("maximum_balance") @db.Decimal(15, 2)
  maximumCreditLimit Decimal @default(0) @map("maximum_credit_limit") @db.Decimal(15, 2)
  maximumDebtLimit   Decimal @default(0) @map("maximum_debt_limit") @db.Decimal(15, 2)

  // Transaction Amount Limits
  minTransactionAmount    Decimal @map("min_transaction_amount") @db.Decimal(15, 2)
  maxTransactionAmount    Decimal @map("max_transaction_amount") @db.Decimal(15, 2)
  dailyTransactionLimit   Decimal @map("daily_transaction_limit") @db.Decimal(15, 2)
  monthlyTransactionLimit Decimal @map("monthly_transaction_limit") @db.Decimal(15, 2)

  // Transaction Count Limits
  dailyTransactionCount   Int @map("daily_transaction_count")
  monthlyTransactionCount Int @map("monthly_transaction_count")

  // Dynamic KYC Requirements (JSON)
  requiredKycFields String[] @default([]) @map("required_kyc_fields")
  kycRules          Json     @default("{}") @map("kyc_rules") // Map of rule_name -> value

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  kycRecords MobileUserKYC[]

  @@unique([position])
  @@index([isDefault])
  @@map("fdh_wallet_tiers")
}

model Workflow {
  id          String  @id @default(cuid())
  name        String  @unique @db.Text
  description String? @db.Text

  isActive Boolean @default(true) @map("is_active")
  version  Int     @default(1)

  // Workflow-level configuration for API mapping
  config Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  steps       WorkflowStep[]
  screenPages AppScreenPageWorkflow[]
  executions  WorkflowExecution[]

  @@index([isActive])
  @@map("workflows")
}

model WorkflowExecution {
  id         String @id @default(cuid())
  workflowId String @map("workflow_id")
  userId     String @map("user_id")
  sessionId  String @map("session_id")

  currentStepId String?                 @map("current_step_id")
  status        WorkflowExecutionStatus @default(IN_PROGRESS)

  // Only store final result, NOT intermediate inputs (stored in Redis)
  finalResult Json?   @map("final_result")
  error       String? @db.Text

  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id])

  @@index([workflowId])
  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@map("workflow_executions")
}

model WorkflowStep {
  id         String @id @default(cuid())
  workflowId String @map("workflow_id")

  // Step details
  type  WorkflowStepType
  label String           @db.Text
  order Int              @default(0)

  // Step configuration (JSON for flexibility)
  config Json

  // Validation rules (optional)
  validation Json?

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Execution configuration
  executionMode   StepExecutionMode @default(CLIENT_ONLY) @map("execution_mode")
  triggerTiming   TriggerTiming?    @map("trigger_timing")
  triggerEndpoint String?           @map("trigger_endpoint") @db.Text
  triggerConfig   Json?             @map("trigger_config")
  timeoutMs       Int?              @map("timeout_ms")
  retryConfig     Json?             @map("retry_config")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([type])
  @@index([order])
  @@index([isActive])
  @@index([executionMode])
  @@map("workflow_steps")
}
